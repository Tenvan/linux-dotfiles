---
- name: Set powerline fonts in vconsole
  lineinfile:
    path: /etc/vconsole.conf
    create: true
    regexp: "^FONT="
    line: FONT=ter-powerline-v12n

- name: Grub config
  when: lookup('env', 'DOCKER_CONTAINER') != "true"
  block:
    - name: Disable quiet mode
      replace:
        path: /etc/default/grub
        regexp: '^GRUB_CMDLINE_LINUX=(.*)\squiet(.*)?$'
        replace: 'GRUB_CMDLINE_LINUX=\1\2'

    - name: Gfxmodes
      lineinfile:
        path: /etc/default/grub
        state: present
        regexp: "^.*GRUB_GFXMODE=(.*)?$"
        line: 'GRUB_GFXMODE="3840x2160,2560x1080,1920x1080,auto"'

    - name: Disable Terminal output
      lineinfile:
        path: /etc/default/grub
        state: present
        regexp: "^.*GRUB_TERMINAL_OUTPUT=(.*)$"
        line: "# GRUB_TERMINAL_OUTPUT=console"

    - name: Disable Terminal input
      lineinfile:
        path: /etc/default/grub
        regexp: "^.*GRUB_TERMINAL_INPUT=(.*)$"
        line: "# GRUB_TERMINAL_INPUT=console"

    - name: Menu 1
      lineinfile:
        path: /etc/default/grub
        regexp: "^.*GRUB_HIDDEN_TIMEOUT=(.*)$"
        line: "# GRUB_HIDDEN_TIMEOUT=10"

    - name: Menu 2
      lineinfile:
        path: /etc/default/grub
        regexp: "^.*GRUB_TIMEOUT_STYLE=(.*)$"
        line: "# GRUB_TIMEOUT_STYLE=hidden"

    - name: Grup Timeout to 10 sec
      lineinfile:
        path: /etc/default/grub
        regexp: "^.*GRUB_TIMEOUT=(.*)$"
        line: "GRUB_TIMEOUT=10"

    - name: Install dark matter grub them
      block:
        - name: clone https://gitlab.com/VandalByte/darkmatter-grub-theme.git
          git:
            repo: "https://gitlab.com/VandalByte/darkmatter-grub-theme.git"
            clone: true
            depth: 1
            dest: "{{ build_dir }}/darkmatter-grub-theme"
        - name: Uninstall old theme
          shell: |
            sudo python3 darkmatter-theme.py -u < <(echo y)
          args:
            executable: /bin/bash
            chdir: "{{ build_dir }}/darkmatter-grub-theme"
        - name: Install new theme
          shell: |
            echo {{ grub_theme }} | sudo tee input.txt
            echo 2 | sudo tee -a input.txt
            echo 1 | sudo tee -a input.txt
            python3 darkmatter-theme.py -i < input.txt
            rm input.txt
          args:
            executable: /bin/bash
            chdir: "{{ build_dir }}/darkmatter-grub-theme"
      when: true

    - name: Grub-update MKCONFIG
      shell: grub2-mkconfig --output=/boot/grub2/grub.cfg
      when: is_rhel_based

    - name: Grub-update UPDATE-GRUB
      shell: update-grub
      when: is_arch_based

    - set_fact:
        grub: "{{ lookup('file', '/etc/default/grub') }}"

    - name: Write issue file
      blockinfile:
        path: /etc/issue
        create: true
        block: |
          1: \e[37mWelcome to {{ ansible_facts['distribution'] }}!
          2: \e[34m\r \s
          3: \e[32m\t
          4: \e[32m\d
          5: \e[31m\U
          6: \e[35m\l \e[0mon \e[1;33m
          7: \v
          8: \o
